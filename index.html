<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cadastro - Produtos e Receitas</title>
    <link rel="stylesheet" href="css/main.css">
</head>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Cadastro - Produtos e Receitas</h1>
            <div>
                <button class="btn btn-secondary" onclick="mostrarUUID()">üîç Mostrar UUID</button>
                <button class="btn btn-secondary" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('produtos-novo')">üõí Produtos</button>
            <button class="tab" onclick="showTab('receitas')">Cadastro de Receitas</button>
            <button class="tab" onclick="showTab('tipos-refeicoes')">Tipos de Refei√ß√µes</button>
            <button class="tab" onclick="showTab('clientes')">Cadastro de Clientes</button>
            <button class="tab" onclick="showTab('cardapio')">Planejamento de Card√°pio</button>
        </div>

        <div class="content">
            <!-- ABA: Produtos -->
            <div id="produtos-novo" class="tab-content">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üõí Gest√£o de Produtos</h2>
                        <div>
                            <button class="btn btn-primary" onclick="abrirModalNovoProduto()">+ Novo Produto</button>
                            <button class="btn btn-secondary" onclick="recarregarProdutos()">üîÑ Recarregar</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="busca-produtos" placeholder="üîç Buscar produtos..." style="min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                        <select id="filtro-grupo" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="">Todos os grupos</option>
                            <option value="Ingredientes">Ingredientes</option>
                            <option value="Descart√°veis">Descart√°veis</option>
                            <option value="Outros produtos">Outros produtos</option>
                        </select>
                        <span>Total: <strong id="total-produtos">0</strong> produtos</span>
                    </div>

                    <div class="table-responsive">
                        <table id="tabelaProdutosNovo">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Grupo</th>
                                    <th>Unidade</th>
                                    <th>Peso Bruto</th>
                                    <th>Peso L√≠quido</th>
                                    <th>Pre√ßo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                        Carregando produtos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196f3;">
                        <h3>üîß Status do Sistema</h3>
                        <p><strong>Supabase:</strong> <span id="status-supabase" style="display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #f8d7da; color: #721c24;">Verificando...</span></p>
                        <p><strong>Usu√°rio:</strong> <span id="usuario-info">Carregando...</span></p>
                        <p><strong>√öltimo erro:</strong> <span id="ultimo-erro">Nenhum</span></p>
                    </div>
                </div>
            </div>

            <!-- Cadastro de Receitas -->
            <div id="receitas" class="tab-content hidden">
                <div class="section">
                    <h2>Cadastro de Receitas</h2>
                    <form id="formReceita">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="codigoReceita" class="required">C√≥digo da Receita</label>
                                <input type="text" id="codigoReceita" readonly>
                            </div>
                            <div class="form-group">
                                <label for="descricaoReceita" class="required">Descri√ß√£o da Receita</label>
                                <input type="text" id="descricaoReceita" maxlength="50" required>
                            </div>
                            <div class="form-group">
                                <label for="pesoFinal">Peso Final</label>
                                <input type="number" id="pesoFinal" step="0.001" readonly placeholder="0,000">
                            </div>
                            <div class="form-group">
                                <label for="rendimento">Rendimento</label>
                                <input type="number" id="rendimento" step="0.001" placeholder="0,000">
                            </div>
                            <div class="form-group">
                                <label for="unidadeRendimento">Unidade do Rendimento</label>
                                <select id="unidadeRendimento">
                                    <option value="">Selecione...</option>
                                    <option value="UN">UN</option>
                                    <option value="KG">KG</option>
                                    <option value="L">L</option>
                                </select>
                            </div>
                        </div>

                        <!-- Editor de Receita -->
                        <div class="form-group full-width">
                            <label for="textoReceita">Modo de Preparo</label>
                            <div class="recipe-editor" id="recipeEditor">
                                <!-- Barra de Ferramentas -->
                                <div class="editor-toolbar">
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Negrito (Ctrl+B)">
                                            <strong>B</strong>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="It√°lico (Ctrl+I)">
                                            <em>I</em>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Sublinhado (Ctrl+U)">
                                            <u>U</u>
                                        </button>
                                    </div>
                                    
                                    <div class="toolbar-group">
                                        <select class="font-size-select" onchange="changeFontSize(this.value)" title="Tamanho da fonte">
                                            <option value="12px">12px</option>
                                            <option value="14px" selected>14px</option>
                                            <option value="16px">16px</option>
                                            <option value="18px">18px</option>
                                            <option value="20px">20px</option>
                                            <option value="24px">24px</option>
                                        </select>
                                    </div>

                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Lista com marcadores">
                                            ‚â°
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Lista numerada">
                                            1.
                                        </button>
                                    </div>

                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="clearFormatting()" title="Limpar formata√ß√£o">
                                            üßπ
                                        </button>
                                    </div>

                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="setEditorSize('small')" title="Tamanho pequeno">
                                            üì±
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="setEditorSize('medium')" title="Tamanho m√©dio">
                                            üíª
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="setEditorSize('large')" title="Tamanho grande">
                                            üñ•Ô∏è
                                        </button>
                                    </div>
                                </div>

                                <!-- √Årea de Edi√ß√£o -->
                                <div class="editor-content" 
                                     id="textoReceita" 
                                     contenteditable="true" 
                                     placeholder="Digite aqui o modo de preparo da receita..."
                                     oninput="updateRecipeText()"
                                     onkeydown="handleEditorKeydown(event)">
                                </div>

                                <!-- Handle de redimensionamento -->
                                <div class="resize-handle" id="resizeHandle"></div>

                                <!-- Footer -->
                                <div class="editor-footer">
                                    <div class="char-counter">
                                        <span id="charCount">0</span> caracteres
                                    </div>
                                    <div class="editor-tips">
                                        <small>üí° Dica: Use <kbd>Ctrl+B</kbd>, <kbd>Ctrl+I</kbd>, <kbd>Ctrl+U</kbd> para formata√ß√£o r√°pida</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Salvar Receita</button>
                            <button type="button" class="btn btn-secondary" onclick="limparFormularioReceita()">Limpar</button>
                            <button type="button" class="btn btn-success" onclick="previewReceita()">Visualizar</button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h3>Ingredientes</h3>
                    <button type="button" class="btn btn-primary" onclick="abrirModalIngredientes()">Selecionar Ingredientes</button>
                    <div class="table-responsive">
                        <table id="tabelaIngredientes">
                            <thead>
                                <tr>
                                    <th>C√≥d. Produto</th>
                                    <th>Nome</th>
                                    <th>Quantidade</th>
                                    <th>UMB</th>
                                    <th>% Perda</th>
                                    <th>% Ganho</th>
                                    <th>Pre√ßo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section">
                    <h3>C√°lculos</h3>
                    <button type="button" class="btn btn-success" onclick="calcularReceita()">Calcular</button>
                    <div id="resultadosCalculos" class="form-grid">
                        <div class="card">
                            <h4>Pre√ßo Total</h4>
                            <p id="precoTotal">R$ 0,00</p>
                        </div>
                        <div class="card">
                            <h4>Peso Final</h4>
                            <p id="pesoFinalCalculado">0,000 KG</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Lista de Receitas</h3>
                    <div class="table-responsive">
                        <table id="tabelaReceitas">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Rendimento</th>
                                    <th>Peso Final</th>
                                    <th>Pre√ßo Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tipos de Refei√ß√µes -->
            <div id="tipos-refeicoes" class="tab-content hidden">
                <div class="section">
                    <h2>Cadastro de Tipos de Refei√ß√µes</h2>
                    <form id="formTipoRefeicao">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="codigoTipoRefeicao" class="required">C√≥digo do Tipo de Refei√ß√£o</label>
                                <input type="text" id="codigoTipoRefeicao" readonly>
                            </div>
                            <div class="form-group">
                                <label for="descricaoTipoRefeicao" class="required">Descri√ß√£o do Tipo de Refei√ß√£o</label>
                                <input type="text" id="descricaoTipoRefeicao" maxlength="25" required>
                            </div>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Salvar Tipo de Refei√ß√£o</button>
                            <button type="button" class="btn btn-secondary" onclick="limparFormularioTipoRefeicao()">Limpar</button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h3>Lista de Tipos de Refei√ß√µes</h3>
                    <div class="table-responsive">
                        <table id="tabelaTiposRefeicoes">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cadastro de Clientes -->
            <div id="clientes" class="tab-content hidden">
                <div class="section">
                    <h2>Cadastro de Clientes</h2>
                    <form id="formCliente">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="codigoCliente" class="required">C√≥digo do Cliente</label>
                                <input type="text" id="codigoCliente" readonly>
                            </div>
                            <div class="form-group">
                                <label for="descricaoCliente" class="required">Descri√ß√£o do Cliente</label>
                                <input type="text" id="descricaoCliente" maxlength="50" required>
                            </div>
                            <div class="form-group">
                                <label for="enderecoCliente">Endere√ßo</label>
                                <input type="text" id="enderecoCliente" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="numeroCliente">N√∫mero</label>
                                <input type="text" id="numeroCliente" maxlength="4">
                            </div>
                            <div class="form-group">
                                <label for="telefoneCliente">Telefone</label>
                                <input type="tel" id="telefoneCliente" placeholder="(00)00000-0000">
                            </div>
                            <div class="form-group">
                                <label for="emailCliente">E-mail</label>
                                <input type="email" id="emailCliente">
                            </div>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                            <button type="button" class="btn btn-secondary" onclick="limparFormularioCliente()">Limpar</button>
                        </div>
                    </form>
                </div>

                <div class="section">
                    <h3>Vincular Tipos de Refei√ß√µes</h3>
                    <button type="button" class="btn btn-primary" onclick="abrirModalTiposRefeicao()">Adicionar Tipos de Refei√ß√£o</button>
                    <div id="tiposRefeicaoVinculados">
                    </div>
                </div>

                <div class="section">
                    <h3>Lista de Clientes</h3>
                    <div class="table-responsive">
                        <table id="tabelaClientes">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Endere√ßo</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Planejamento de Card√°pio -->
            <div id="cardapio" class="tab-content hidden">
                <!-- Calend√°rio com op√ß√£o de mostrar/ocultar -->
                <div class="calendar-toggle">
                    <button class="btn btn-secondary" onclick="toggleCalendar()">
                        <span id="calendar-toggle-text">Ocultar Calend√°rio</span>
                    </button>
                </div>
                
                <div class="calendar-container" id="calendarContainer">
                    <div class="calendar-header">
                        <button onclick="mudarMes(-1)" class="btn btn-secondary">‚ùÆ</button>
                        <span id="mesAno"></span>
                        <button onclick="mudarMes(1)" class="btn btn-secondary">‚ùØ</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                    </div>
                </div>

                <div class="section">
                    <h2>Planejamento de Card√°pio</h2>
                    <div class="form-grid cardapio-form-grid">
                        <div class="form-group">
                            <label for="clienteCardapio" class="required">Cliente</label>
                            <select id="clienteCardapio" required onchange="carregarTiposRefeicaoCliente()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dataCardapio" class="required">Data</label>
                            <input type="date" id="dataCardapio" required onchange="carregarCardapioData()">
                        </div>
                        <div class="form-group">
                            <label for="totalComensais">Total Comensais</label>
                            <input type="number" id="totalComensais" min="1" class="compact-input">
                        </div>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn btn-secondary compact-btn" onclick="atualizarParaTodos()">Atualizar</button>
                        <button type="button" class="btn btn-success compact-btn" onclick="calcularParaTodos()">Calcular para Todos</button>
                        <button type="button" class="btn btn-primary compact-btn" onclick="gravarParaTodos()">Gravar para Todos</button>
                        <button type="button" class="btn btn-primary compact-btn" onclick="abrirModalImpressao()">Imprimir</button>
                        <button type="button" class="btn btn-info compact-btn" onclick="abrirVisualizacaoSemanal()">üìÖ Vis√£o Semanal</button>
                    </div>
                </div>

                <div class="section">
                    <h3>Tipos de Refei√ß√µes do Cliente</h3>
                    <div id="tiposRefeicaoCardapio">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Produto -->
    <div id="modal-produto" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalProduto()">&times;</span>
            <h2>üì¶ Produto</h2>
            <form>
                <input type="hidden" id="produto-id">
                
                <div class="form-group">
                    <label for="produto-codigo">C√≥digo:</label>
                    <input type="text" id="produto-codigo" readonly style="background-color: #f8f9fa;">
                </div>
                
                <div class="form-group">
                    <label for="produto-descricao">Descri√ß√£o: *</label>
                    <input type="text" id="produto-descricao" required>
                </div>
                
                <div class="form-group">
                    <label for="produto-grupo">Grupo:</label>
                    <select id="produto-grupo">
                        <option value="Ingredientes">Ingredientes</option>
                        <option value="Descart√°veis">Descart√°veis</option>
                        <option value="Outros produtos">Outros produtos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="produto-unidade">Unidade de Medida:</label>
                    <select id="produto-unidade">
                        <option value="KG">KG</option>
                        <option value="L">L</option>
                        <option value="UN">UN</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="produto-peso-bruto">Peso Bruto:</label>
                    <input type="number" id="produto-peso-bruto" step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label for="produto-peso-liquido">Peso L√≠quido:</label>
                    <input type="number" id="produto-peso-liquido" step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label for="produto-preco">Pre√ßo:</label>
                    <input type="number" id="produto-preco" step="0.01" min="0">
                </div>
            </form>
            <div class="actions">
                <button class="btn btn-secondary" onclick="fecharModalProduto()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Outros Modais -->
    <div id="modalIngredientes" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalIngredientes')">&times;</span>
            <h2>Selecionar Ingredientes</h2>
            <div class="search-box">
                <input type="text" id="searchIngredientes" placeholder="Pesquisar por nome do produto..." onkeyup="filtrarIngredientes()">
            </div>
            <div id="listaIngredientes">
            </div>
        </div>
    </div>

    <div id="modalTiposRefeicao" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalTiposRefeicao')">&times;</span>
            <h2>Selecionar Tipos de Refei√ß√£o</h2>
            <div id="listaTiposRefeicao">
            </div>
        </div>
    </div>

    <div id="modalReceitas" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalReceitas')">&times;</span>
            <h2>Selecionar Receitas</h2>
            <div class="search-box">
                <input type="text" id="searchReceitas" placeholder="Pesquisar por nome da receita..." onkeyup="filtrarReceitas()">
            </div>
            <div id="listaReceitasModal">
            </div>
            <div class="actions">
                <button type="button" class="btn btn-primary" onclick="adicionarReceitasSelecionadas()">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script src="js/receitas.js"></script>
    <script src="js/tipos-refeicoes.js"></script>
    <script src="js/clientes.js"></script>
    <script src="js/cardapio.js"></script>

    <!-- Script inline para produtos -->
    <script>
        // PRODUTOS - INTEGRADO NO SISTEMA
        console.log('üöÄ Iniciando sistema de produtos...');
        
        let produtosNovoSistema = [];
        let editandoNovoSistema = null;

        // Aguardar Supabase
        function aguardarSupabaseNovoSistema(callback, tentativas = 0) {
            if (window.supabase && window.supabase.auth) {
                callback();
            } else if (tentativas < 50) {
                setTimeout(() => aguardarSupabaseNovoSistema(callback, tentativas + 1), 100);
            } else {
                alert('Erro: Supabase n√£o carregou');
            }
        }

        // Inicializar quando aba produtos-novo for selecionada
        function inicializarProdutosNovo() {
            aguardarSupabaseNovoSistema(async () => {
                try {
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    document.getElementById('status-supabase').textContent = 'Conectado';
                    document.getElementById('status-supabase').style.background = '#d4edda';
                    document.getElementById('status-supabase').style.color = '#155724';
                    document.getElementById('usuario-info').textContent = user.email;
                    
                    await carregarProdutosNovoSistema();
                    await gerarCodigoNovoSistema();
                    configurarEventosNovoSistema();
                    
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('ultimo-erro').textContent = error.message;
                }
            });
        }

        function configurarEventosNovoSistema() {
            const buscaInput = document.getElementById('busca-produtos');
            const filtroSelect = document.getElementById('filtro-grupo');
            
            if (buscaInput) {
                buscaInput.removeEventListener('input', filtrarNovoSistema);
                buscaInput.addEventListener('input', filtrarNovoSistema);
            }
            if (filtroSelect) {
                filtroSelect.removeEventListener('change', filtrarNovoSistema);
                filtroSelect.addEventListener('change', filtrarNovoSistema);
            }
        }

        async function gerarCodigoNovoSistema() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                const { data, error } = await window.supabase.rpc('get_next_produto_codigo', {
                    user_uuid: user.id
                });
                if (error) throw error;
                
                const input = document.getElementById('produto-codigo');
                if (input) {
                    input.value = data || 'PR000001';
                }
            } catch (error) {
                const input = document.getElementById('produto-codigo');
                if (input) {
                    input.value = 'PR000001';
                }
            }
        }

        async function carregarProdutosNovoSistema() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                const { data, error } = await window.supabase
                    .from('produtos')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('codigo');

                if (error) throw error;
                produtosNovoSistema = data || [];
                renderizarNovoSistema();
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('ultimo-erro').textContent = error.message;
            }
        }

        function renderizarNovoSistema() {
            const tbody = document.getElementById('produtos-tbody');
            const total = document.getElementById('total-produtos');
            
            if (!tbody || !total) return;
            
            tbody.innerHTML = '';
            total.textContent = produtosNovoSistema.length;

            if (produtosNovoSistema.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhum produto encontrado</td></tr>';
                return;
            }

            produtosNovoSistema.forEach(produto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${produto.codigo}</td>
                    <td>${produto.descricao}</td>
                    <td>${produto.grupo}</td>
                    <td>${produto.unidade_medida}</td>
                    <td>${produto.peso_bruto || '-'}</td>
                    <td>${produto.peso_liquido || '-'}</td>
                    <td>R$ ${parseFloat(produto.preco || 0).toFixed(2)}</td>
                    <td>
                        <button onclick="editarNovoSistema('${produto.id}')" class="btn btn-primary btn-sm">Editar</button>
                        <button onclick="excluirNovoSistema('${produto.id}')" class="btn btn-danger btn-sm">Excluir</button>
                    </td>
                `;
            });
        }

        function filtrarNovoSistema() {
            const busca = document.getElementById('busca-produtos')?.value.toLowerCase() || '';
            const grupo = document.getElementById('filtro-grupo')?.value || '';
            
            let filtrados = produtosNovoSistema.filter(p => {
                const matchBusca = !busca || p.descricao.toLowerCase().includes(busca) || p.codigo.toLowerCase().includes(busca);
                const matchGrupo = !grupo || p.grupo === grupo;
                return matchBusca && matchGrupo;
            });
            
            const tbody = document.getElementById('produtos-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            filtrados.forEach(produto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${produto.codigo}</td>
                    <td>${produto.descricao}</td>
                    <td>${produto.grupo}</td>
                    <td>${produto.unidade_medida}</td>
                    <td>${produto.peso_bruto || '-'}</td>
                    <td>${produto.peso_liquido || '-'}</td>
                    <td>R$ ${parseFloat(produto.preco || 0).toFixed(2)}</td>
                    <td>
                        <button onclick="editarNovoSistema('${produto.id}')" class="btn btn-primary btn-sm">Editar</button>
                        <button onclick="excluirNovoSistema('${produto.id}')" class="btn btn-danger btn-sm">Excluir</button>
                    </td>
                `;
            });
        }

        async function abrirModalNovoProduto() {
            await gerarCodigoNovoSistema();
            document.getElementById('produto-id').value = '';
            document.getElementById('produto-descricao').value = '';
            document.getElementById('produto-grupo').value = 'Ingredientes';
            document.getElementById('produto-unidade').value = 'KG';
            document.getElementById('produto-peso-bruto').value = '';
            document.getElementById('produto-peso-liquido').value = '';
            document.getElementById('produto-preco').value = '';
            document.getElementById('modal-produto').style.display = 'block';
            
            setTimeout(() => {
                const descInput = document.getElementById('produto-descricao');
                if (descInput) descInput.focus();
            }, 100);
        }

        async function salvarProduto() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                
                const id = document.getElementById('produto-id').value;
                const dados = {
                    codigo: document.getElementById('produto-codigo').value.trim(),
                    descricao: document.getElementById('produto-descricao').value.trim(),
                    grupo: document.getElementById('produto-grupo').value,
                    unidade_medida: document.getElementById('produto-unidade').value,
                    peso_bruto: parseFloat(document.getElementById('produto-peso-bruto').value) || null,
                    peso_liquido: parseFloat(document.getElementById('produto-peso-liquido').value) || null,
                    preco: parseFloat(document.getElementById('produto-preco').value) || null,
                    user_id: user.id
                };

                if (!dados.descricao) {
                    alert('Informe a descri√ß√£o');
                    document.getElementById('produto-descricao').focus();
                    return;
                }

                let result;
                if (id) {
                    result = await window.supabase.from('produtos').update(dados).eq('id', id).eq('user_id', user.id);
                } else {
                    result = await window.supabase.from('produtos').insert([dados]);
                }

                if (result.error) throw result.error;

                alert(id ? 'Produto atualizado com sucesso!' : 'Produto criado com sucesso!');
                fecharModalProduto();
                await carregarProdutosNovoSistema();

            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro: ' + error.message);
                document.getElementById('ultimo-erro').textContent = error.message;
            }
        }

        function editarNovoSistema(id) {
            const produto = produtosNovoSistema.find(p => p.id === id);
            if (!produto) return;

            document.getElementById('produto-id').value = produto.id;
            document.getElementById('produto-codigo').value = produto.codigo;
            document.getElementById('produto-descricao').value = produto.descricao;
            document.getElementById('produto-grupo').value = produto.grupo;
            document.getElementById('produto-unidade').value = produto.unidade_medida;
            document.getElementById('produto-peso-bruto').value = produto.peso_bruto || '';
            document.getElementById('produto-peso-liquido').value = produto.peso_liquido || '';
            document.getElementById('produto-preco').value = produto.preco || '';
            document.getElementById('modal-produto').style.display = 'block';
            
            setTimeout(() => {
                const descInput = document.getElementById('produto-descricao');
                if (descInput) descInput.focus();
            }, 100);
        }

        async function excluirNovoSistema(id) {
            const produto = produtosNovoSistema.find(p => p.id === id);
            if (!produto || !confirm(`Excluir "${produto.descricao}"?`)) return;

            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                const { error } = await window.supabase
                    .from('produtos')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                    
                if (error) throw error;
                alert('Produto exclu√≠do com sucesso!');
                await carregarProdutosNovoSistema();
            } catch (error) {
                alert('Erro: ' + error.message);
                document.getElementById('ultimo-erro').textContent = error.message;
            }
        }

        function fecharModalProduto() {
            document.getElementById('modal-produto').style.display = 'none';
        }

        async function recarregarProdutos() {
            await carregarProdutosNovoSistema();
            alert('Produtos recarregados!');
        }

        // Exportar fun√ß√µes globais
        window.abrirModalNovoProduto = abrirModalNovoProduto;
        window.salvarProduto = salvarProduto;
        window.editarNovoSistema = editarNovoSistema;
        window.excluirNovoSistema = excluirNovoSistema;
        window.fecharModalProduto = fecharModalProduto;
        window.recarregarProdutos = recarregarProdutos;
        window.inicializarProdutosNovo = inicializarProdutosNovo;

        // Fechar modal ao clicar fora
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modal-produto');
            if (event.target === modal) {
                fecharModalProduto();
            }
        });

        console.log('‚úÖ Sistema de produtos carregado!');
    </script>

    <!-- Estilos adicionais -->
    <style>
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal-content {
            max-width: 600px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</body>
</html>